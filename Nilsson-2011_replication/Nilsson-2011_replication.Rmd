---
title: "Nilsson et al., 2011 Simulation"
author: "Wei-Lun, Lin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rstan)
```


##  Study 2: Application to behavioral data

The study analyzed the data from study 2 in Rieskamp (2008).
The study featured 30 participants, each of which was confronted with a series of 180 pairs of gambles. (60 gains, 60 losses, 60 mixed).

```{r read Rieskamp data}
gambles <- read.csv("./Nilsson-2011_replication/Rieskamp_2008_gamble.csv")[, 1:9]
choices <- read.csv("./Nilsson-2011_replication/Rieskamp_2008_choice.csv")[, -2]

head(gambles)
head(choices)
```

```{r arrange gambles}
gambles <- gambles %>%
  rename(
    trial = choicepair,
    xA1 = A1_payoff,
    xA2 = A2_payoff,
    pA = A1_prob,
    pB = B1_prob,
    xB1 = B1_payoff,
    xB2 = B2_payoff
  ) %>% 
  select(-ends_with("prob"))

head(gambles)
```

```{r arrange choices}
choices <- choices %>% 
  rename(trial = choice.pair) %>% 
  rename_with(~ gsub("X", "subj-", .x))

head(choices)
```



```{r}
df <- gambles %>% 
  bind_cols(choices[, -1]) %>% 
  pivot_longer(
    starts_with("subj-"),
    names_to = "subj_id",
    values_to = "choice"
  ) %>% 
  relocate(subj_id) %>% 
  mutate(subj_id = gsub("subj-*", "", subj_id) %>% as.numeric()) %>% 
  arrange(subj_id)

# write.csv(df, "./Rieskamp_subj-trial_data.csv", row.names=F)

dim(df)
head(df)
```


## MCMC

Nilsson estimated posterior distributions based on a total of 50000 MCMC samples from 3 chainsk after a burn-in of 1000 samples and after subsampling such that only every 10th sample was recorded.

Full model:

```{r full model}
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

df <- read.csv("./Rieskamp_subj-trial_data.csv")

Rieskamp_stan_data <- df %>%
  list(
    N    = nrow(.),
    S    = length(unique(.$subj_id)),
    subj = .$subj_id,
    y    = .$choice,
    xA1  = .$xA1,
    xA2  = .$xA2,
    pA   = .$pA,
    xB1  = .$xB1,
    xB2  = .$xB2,
    pB   = .$pB
  )

# Fit model
fit.full <- stan(
  file = "./hierarchical_CPT.stan",
  data = Rieskamp_stan_data,
  chains = 3,
  iter = 17666,
  warmup = 1000,
  # thin = 10,
  seed = 2025
)

saveRDS(fit.full, file = "./Nilsson-2011_fit-full.rds")
```


Restricted model: $\alpha=\beta$

```{r restricted model}
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

# Fit model
fit.restricted <- stan(
  file = "./hierarchical_CPT_restricted.stan",
  data = Rieskamp_stan_data,
  chains = 3,
  iter = 17666,
  warmup = 1000,
  # thin = 10,
  seed = 2025
)

saveRDS(fit.restricted, file = "./Nilsson-2011_fit-restricted.rds")
```


Use CPT to generate 3 sets of choice data, each set containing 30 synthetic subjects that undergo 60 pairs of mixed gambles.
The generative parameter values for each synthetic subject were set to the value provided by Tversky and Kahneman (1992): $\alpha=.88, \beta=.88, \gamma=.61, \delta=.69$ and $\lambda=2.25$.
The 3 levels of sensitivity parameter $\phi$ were $\phi=.04$(high noise), $\phi=.14$(medium noise), and $\phi=.40$(low noise).


